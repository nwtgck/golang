version: 2

ANCHORS:
  build_go_steps: &build_go_steps
    steps:
      - checkout
      - run: |
          apt update
          apt install -y wget binutils build-essential zip
      - run: |
          wget https://storage.googleapis.com/golang/go1.4.2.linux-amd64.tar.gz
          mkdir tmp
          tar zxvf go1.4.2.linux-amd64.tar.gz -C tmp/
          mv tmp/go $HOME/go1.4
          rm go1.4.2.linux-amd64.tar.gz
      - run:
          name: Build
          command: |
            cd src
            ./make.bash
      - run:
          name: Create a zip file including go in /root/artifacts
          command: |
            mkdir -p /root/artifacts/go_${GOOS}_${GOARCH}
            mv /root/project/bin/go /root/artifacts/go_${GOOS}_${GOARCH}
            cd /root/artifacts
            zip -r go_${GOOS}_${GOARCH}.zip go_${GOOS}_${GOARCH}
            rm -r go_${GOOS}_${GOARCH}
      - run: |
          mkdir /env
          echo $GOOS > /env/GOOS
          echo $GOARCH > /env/GOARCH
      - save_cache:
          key: go-{{ checksum "/env/GOOS" }}-{{ checksum "/env/GOARCH" }}-{{ .Branch }}-{{ .Revision }}
          paths:
            - /root/artifacts

jobs:
  build_linux_amd64:
    docker:
      - image: ubuntu:16.04
    environment:
      GOOS: linux
      GOARCH: amd64
    <<: *build_go_steps

  build_darwin_amd64:
    docker:
      - image: ubuntu:16.04
    environment:
      GOOS: darwin
      GOARCH: amd64
    <<: *build_go_steps

  docker_test:
    machine: true
    steps:
      - checkout
      # Check whether "docker build" is succcessful or not
      - run: docker build -t golang .
      - run:
          name: Working test with Docker image
          command: |
            # Create main.go
            # (NOTE: fmt is not used at all)
            cat << EOS > main.go
            package main

            import "fmt"

            func main() {

            }
            EOS

            echo "It should fail without GO_IGNORE_UNUSED_PKG"
            ! docker run --rm -v $PWD/main.go:/main.go golang go run /main.go

            echo "It should pass with GO_IGNORE_UNUSED_PKG"
            docker run --rm -v $PWD/main.go:/main.go -e GO_IGNORE_UNUSED_PKG=1 golang go run /main.go

workflows:
  version: 2
  test:
    jobs:
      - build_linux_amd64 
      - build_darwin_amd64
      - docker_test
